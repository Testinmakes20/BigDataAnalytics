#!/usr/bin/perl -w

use strict;

if ($ARGV[0] eq "-list") {
	my @list = list_names($ARGV[1]);
	printf("@list");
} elsif ($ARGV[0] eq "-reduced") {
	my $destination = $ARGV[1];
	install_reduced($destination);
} else {
	my $destination = $ARGV[0];
	install_reduced($destination);
}

sub install_reduced {
	my ($corpusdir) = @_;
	my $src = "apache-roller-src-4.0.1.zip";
	my $bin = "apache-roller-4.0.1.zip";
	my @files = ("apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-collections-3.2.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/spring.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/taglibs-string.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/antlr-2.7.2.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/roller-planet-business.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-beanutils-1.6.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/lucene-1.4.3.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/ognl-2.6.11.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/tiles-core-2.0.4.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/jaxen-full.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-codec-1.3.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-validator-1.3.0.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/standard.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-digester-1.6.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/freemarker-2.3.8.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-httpclient-2.0.2.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/openjpa-0.9.7-incubating.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/struts2-core-2.0.9.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-chain-1.1.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/xmlrpc-common-3.0.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/acegi-security-1.0.3.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/oro-2.0.8.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/ws-commons-util-1.0.1.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/geronimo-jpa_3.0_spec-1.0.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/saxpath.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/struts2-tiles-plugin-2.0.9.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-fileupload-1.2.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/geronimo-j2ee-connector_1.5_spec-1.0.1.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/geronimo-jta_1.0.1B_spec-1.0.1.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/log4j-1.2.11.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/velocity-1.5.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/ehcache-1.1.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/xwork-2.0.4.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/serializer.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/roller-web.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/xmlrpc-server-3.0.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/struts2-spring-plugin-2.0.9.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-lang-2.1.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/jdom.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/concurrent-1.3.2.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/xalan.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-id-0.1-SNAPSHOT.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/tiles-api-2.0.4.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/serp-1.11.0.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/jstl.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-io-1.3.1.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/rome-fetcher-0.9.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/guice-1.0.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/tiles-jsp-2.0.4.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/xmlrpc-client-3.0.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/commons-logging-1.0.4.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/roller-business.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/rome-0.9.jar","apache-roller-4.0.1/webapp/roller/WEB-INF/lib/roller-core.jar");
	printf("\t\t unpacking $src\n");
	system("unzip -qo $corpusdir/compressed/$src -d $corpusdir/src\n") == 0 or die "Failed to extract $src\n";
	printf("\t\t unpacking $bin\n");
	system("unzip -qo $corpusdir/compressed/$bin @files -d $corpusdir/bin\n") == 0 or die "Failed to extract $bin\n";
}

sub list_names {
	my ($appverdir) = @_;
	opendir(COMPRESSED, "$appverdir/compressed") || die "can't open $appverdir/compressed: $!";
	my @archives = grep {! /^\.$/ and ! /^\.\.$/ } readdir(COMPRESSED);
	close(COMPRESSED);
	return @archives;
}
